#!/bin/bash
set -Eeuo pipefail

# DebianDC defaults (optional)
source /usr/local/debiandc/common-value 2>/dev/null || true

MANAGER="/usr/local/debiandc/manager"
CFG_D_FILE="/etc/network/interfaces.d/debiandcnw"
IFACES_FILE="/etc/network/interfaces"

LOG_DIR="/var/log/debiandc"
LOG_FILE="$LOG_DIR/set_static_ip.log"

RESOLV_HOOK="/etc/network/if-up.d/debiandc-resolv"
RESOLV_HOOK_LOG="$LOG_DIR/debiandc-resolv.log"

mkdir -p "$LOG_DIR"
touch "$LOG_FILE" "$RESOLV_HOOK_LOG" || true
chmod 600 "$LOG_FILE" || true
chmod 644 "$RESOLV_HOOK_LOG" || true

ts(){ date -Is; }
log(){ echo "[$(ts)] $*" >> "$LOG_FILE"; }

fatal(){
  local msg="$1"
  log "[FATAL] $msg"
  zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="$msg\n\nLog: $LOG_FILE" || true
  exit 1
}

return_to_manager(){
  if [[ -x "$MANAGER" ]]; then
    exec "$MANAGER"
  fi
  zenity --warning --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="manager script not found!!: $MANAGER" || true
  exit 0
}

on_err(){
  local ec=$?
  log "[ERR] Exit code: $ec (line $1)"
  local tail_txt
  tail_txt="$(tail -n 80 "$LOG_FILE" 2>/dev/null || true)"
  zenity --error --width="${WIDTH:-900}" --title="DebianDC Static IP - Error" \
    --text="Process failed (exit=$ec). Returning to Manager.\n\nLast logs:\n$tail_txt\n\nLog: $LOG_FILE" || true
  return_to_manager
}
trap 'on_err $LINENO' ERR

need_cmd(){
  command -v "$1" >/dev/null 2>&1 || fatal "Required command not found: $1"
}

IFDOWN="$(command -v ifdown 2>/dev/null || true)"
IFUP="$(command -v ifup 2>/dev/null || true)"
[[ -n "$IFDOWN" ]] || IFDOWN="/sbin/ifdown"
[[ -n "$IFUP" ]]   || IFUP="/sbin/ifup"

list_ifaces(){
  ip -o link show | awk -F': ' '{print $2}' | grep -v '^lo$' | sort -u
}

valid_ipv4(){
  local ip="$1"
  [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || return 1
  IFS='.' read -r a b c d <<<"$ip"
  for n in "$a" "$b" "$c" "$d"; do
    [[ "$n" -ge 0 && "$n" -le 255 ]] || return 1
  done
  return 0
}

valid_netmask(){ valid_ipv4 "$1"; }

normalize_dns_list(){
  # Accept "a,b,c" or "a b c"
  echo "$1" | tr ',' ' ' | xargs
}

backup_file(){
  local f="$1"
  [[ -f "$f" ]] || return 0
  cp -a "$f" "${f}.bak.$(date +%Y%m%d-%H%M%S)" || true
}

write_atomic(){
  local target="$1"
  local tmp
  tmp="$(mktemp)"
  cat >"$tmp"
  chmod 644 "$tmp"
  mv -f "$tmp" "$target"
}

ensure_interfaces_include() {
  local f="$IFACES_FILE"
  [[ -f "$f" ]] || touch "$f"
  if ! grep -qE '^[[:space:]]*source[[:space:]]+/etc/network/interfaces\.d/\*$' "$f"; then
    log "Adding interfaces.d include line to $f"
    printf "\n# DebianDC: include per-interface configs\nsource /etc/network/interfaces.d/*\n" >> "$f"
  fi
}

remove_dhcp_stanzas(){
  local f="$1"
  [[ -f "$f" ]] || return 0
  backup_file "$f"

  awk '
    BEGIN {skip=0}
    /^[[:space:]]*iface[[:space:]].*[[:space:]]inet[[:space:]]dhcp[[:space:]]*$/ {skip=1; next}
    /^[[:space:]]*iface[[:space:]]/ {skip=0}
    /^[[:space:]]*auto[[:space:]]/ {skip=0}
    /^[[:space:]]*allow-hotplug[[:space:]]/ {skip=0}
    skip==1 && /^[[:space:]]+/ {next}
    skip==1 && /^[[:space:]]*$/ {skip=0; next}
    {print}
  ' "$f" > "${f}.tmp"

  mv -f "${f}.tmp" "$f"
}

remove_dhcp_from_interfaces_d(){
  shopt -s nullglob
  local f
  for f in /etc/network/interfaces.d/*; do
    [[ -f "$f" ]] || continue
    [[ "$f" == "$CFG_D_FILE" ]] && continue
    if grep -qE '^[[:space:]]*iface[[:space:]].*[[:space:]]inet[[:space:]]dhcp[[:space:]]*$' "$f"; then
      log "Removing DHCP stanza from $f"
      remove_dhcp_stanzas "$f" || true
    fi
  done
}

write_debiandcnw(){
  local iface="$1" ipaddr="$2" netmask="$3" gw="$4" dns_list="$5"
  mkdir -p /etc/network/interfaces.d
  backup_file "$CFG_D_FILE"
  {
    echo "auto $iface"
    echo "iface $iface inet static"
    echo "    address $ipaddr"
    echo "    netmask $netmask"
    [[ -n "$gw" ]] && echo "    gateway $gw"
    echo "    dns-nameservers $dns_list"
  } | write_atomic "$CFG_D_FILE"
  log "Wrote $CFG_D_FILE"
}

install_resolv_hook_v2(){
  mkdir -p /etc/network/if-up.d

  cat > "$RESOLV_HOOK" <<EOF
#!/bin/sh
set -eu

CFG="$CFG_D_FILE"
OUT="/etc/resolv.conf"
LOG_DIR="$LOG_DIR"
LOG_FILE="$RESOLV_HOOK_LOG"

mkdir -p "\$LOG_DIR" 2>/dev/null || true
touch "\$LOG_FILE" 2>/dev/null || true
chmod 644 "\$LOG_FILE" 2>/dev/null || true

ts(){ date -Is; }
hlog(){ echo "[\$(ts)] \$*" >> "\$LOG_FILE"; }

if [ "${IFACE:-}" = "lo" ]; then
  hlog "Skipping loopback interface"
  exit 0
fi

is_dc_role() {
  # 1) Samba private dir check
  if [ -d /var/lib/samba/private ]; then
    return 0
  fi

  # 2) systemctl check (if systemd exists)
  if command -v systemctl >/dev/null 2>&1; then
    if systemctl is-active --quiet samba-ad-dc 2>/dev/null; then
      return 0
    fi
  fi

  # 3) samba-tool check (only if available)
  if command -v samba-tool >/dev/null 2>&1; then
    if samba-tool domain info localhost >/dev/null 2>&1; then
      return 0
    fi
  fi

  return 1
}

hlog "Hook start: interface=\${IFACE:-unknown}"

# If DC role detected, do not manage resolv.conf here.
if is_dc_role; then
  hlog "DC role detected -> leaving \$OUT to Samba AD DNS"
  exit 0
fi

# DebianDC config absent? do nothing.
if [ ! -f "\$CFG" ]; then
  hlog "No DebianDC config at \$CFG -> nothing to do"
  exit 0
fi

DNS="\$(awk '\$1=="dns-nameservers"{for(i=2;i<=NF;i++) printf("%s ", \$i)}' "\$CFG" | sed 's/[[:space:]]*\$//')"
if [ -z "\$DNS" ]; then
  hlog "No dns-nameservers found in \$CFG -> nothing to write"
  exit 0
fi

# If resolv.conf is symlink, replace with regular file.
if [ -L "\$OUT" ]; then
  hlog "\$OUT is symlink -> removing to create regular file"
  rm -f "\$OUT"
fi

{
  echo "# Generated by DebianDC (if-up hook)"
  for d in \$DNS; do
    echo "nameserver \$d"
  done
} > "\$OUT"

chmod 644 "\$OUT"
hlog "Wrote \$OUT from \$CFG : DNS='\$DNS'"
exit 0
EOF

  chmod 755 "$RESOLV_HOOK"
  log "Installed DC-aware hook: $RESOLV_HOOK (log: $RESOLV_HOOK_LOG)"
}

write_resolv_conf_once(){
  local dns_list="$1"

  # If resolv.conf is symlink, convert to normal file now as well (pre-DC phase)
  [[ -L /etc/resolv.conf ]] && rm -f /etc/resolv.conf

  {
    echo "# Generated by DebianDC set_static_ip.sh"
    for dns in $dns_list; do
      valid_ipv4 "$dns" || fatal "DNS IP not valid: $dns"
      echo "nameserver $dns"
    done
  } > /etc/resolv.conf
  chmod 644 /etc/resolv.conf
  log "Wrote /etc/resolv.conf one-time (pre-DC). Hook will handle reboots (unless DC role exists)."
}

get_current_ipv4_cidr(){
  local iface="$1"
  ip -4 -o addr show dev "$iface" | awk '{print $4}' | head -n1
}

apply_iface(){
  local iface="$1"
  log "Applying interface: $iface (flush + ifdown/ifup)"
  ip addr flush dev "$iface" || true
  "$IFDOWN" --force "$iface" >>"$LOG_FILE" 2>&1 || true
  sleep 1
  "$IFUP" "$iface" >>"$LOG_FILE" 2>&1 || true
  sleep 1
}

########################
# Main
########################

log "==== START set_static_ip.sh v4 ===="

need_cmd zenity
need_cmd ip
[[ -x "$IFDOWN" ]] || fatal "ifdown not found: $IFDOWN (install: ifupdown)"
[[ -x "$IFUP" ]]   || fatal "ifup not found: $IFUP (install: ifupdown)"

IFACE_LIST="$(list_ifaces | paste -sd'|' -)"
[[ -n "$IFACE_LIST" ]] || fatal "NIC adapter not found."

while true; do
  CHOICE="$(zenity --forms --title="DebianDC Static IP Settings" --text="Enter Static IP Info" \
    --width="${WIDTH:-900}" --height="${HEIGHT:-520}" \
    --add-combo="Interface" --combo-values="$IFACE_LIST" \
    --add-entry="IP Address (example: 192.168.1.151)" \
    --add-entry="Netmask (example: 255.255.255.0)" \
    --add-entry="Gateway (optional, example: 192.168.1.1)" \
    --add-entry="DNS Server(s) (example: 192.168.1.10,8.8.8.8)")"
  rc=$?
  if [[ $rc -ne 0 ]]; then
    return_to_manager
  fi

  IFS='|' read -r INTERFACE IPADDRESS NETMASK GATEWAY DNSSERVER <<<"$CHOICE"

  INTERFACE="$(echo "${INTERFACE:-}" | xargs)"
  IPADDRESS="$(echo "${IPADDRESS:-}" | xargs)"
  NETMASK="$(echo "${NETMASK:-}" | xargs)"
  GATEWAY="$(echo "${GATEWAY:-}" | xargs)"
  DNSSERVER="$(echo "${DNSSERVER:-}" | xargs)"

  if [[ -z "$INTERFACE" || -z "$IPADDRESS" || -z "$NETMASK" || -z "$DNSSERVER" ]]; then
    zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="Please fill IP / Netmask / DNS fields." || true
    continue
  fi

  if ! valid_ipv4 "$IPADDRESS"; then
    zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="IP Address not valid: $IPADDRESS" || true
    continue
  fi

  if ! valid_netmask "$NETMASK"; then
    zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="Netmask not valid: $NETMASK" || true
    continue
  fi

  if [[ -n "$GATEWAY" ]] && ! valid_ipv4 "$GATEWAY"; then
    zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="Gateway not valid: $GATEWAY" || true
    continue
  fi

  DNS_LIST="$(normalize_dns_list "$DNSSERVER")"
  if [[ -z "$DNS_LIST" ]]; then
    zenity --error --width="${WIDTH:-700}" --title="DebianDC Static IP" --text="DNS Server field cannot be empty." || true
    continue
  fi

  if ! zenity --question --width="${WIDTH:-800}" --title="Confirm" \
    --text="Apply these settings?\n\nInterface: $INTERFACE\nIP: $IPADDRESS\nNetmask: $NETMASK\nGateway: ${GATEWAY:-Empty}\nDNS: $DNS_LIST\n\nHook log: $RESOLV_HOOK_LOG"; then
    continue
  fi
  break
done

(
  echo "10"; echo "# Preparing /etc/network/interfaces ..."
  ensure_interfaces_include

  echo "25"; echo "# Removing DHCP stanzas ..."
  log "Removing DHCP set from $IFACES_FILE and interfaces.d/*"
  remove_dhcp_stanzas "$IFACES_FILE" || true
  remove_dhcp_from_interfaces_d || true

  echo "45"; echo "# Writing static config ..."
  write_debiandcnw "$INTERFACE" "$IPADDRESS" "$NETMASK" "$GATEWAY" "$DNS_LIST"

  echo "60"; echo "# Installing DC-aware DNS hook ..."
  install_resolv_hook_v2

  echo "70"; echo "# Writing resolv.conf (one-time, pre-DC) ..."
  write_resolv_conf_once "$DNS_LIST"

  echo "85"; echo "# Restarting interface ..."
  apply_iface "$INTERFACE"

  echo "95"; echo "# Verifying ..."
  NEW_IP="$(get_current_ipv4_cidr "$INTERFACE" || true)"
  log "Interface $INTERFACE current IPv4: ${NEW_IP:-N/A}"

  echo "100"; echo "# Completed"
) | zenity --progress --title="DebianDC Static IP" --text="Applying network settings..." --percentage=0 --auto-close || true

NEW_IP="$(get_current_ipv4_cidr "$INTERFACE" || true)"
if [[ -n "$NEW_IP" ]]; then
  zenity --info --width="${WIDTH:-900}" --title="DebianDC Static IP" \
    --text="Completed.\n\nInterface: $INTERFACE\nIP: $NEW_IP\nDNS: $DNS_LIST\n\nLogs:\n- $LOG_FILE\n- $RESOLV_HOOK_LOG" || true
else
  zenity --warning --width="${WIDTH:-900}" --title="DebianDC Static IP" \
    --text="IP address could not be read, but configuration was applied.\n\nInterface: $INTERFACE\nTarget IP: $IPADDRESS\nDNS: $DNS_LIST\n\nLogs:\n- $LOG_FILE\n- $RESOLV_HOOK_LOG" || true
fi

log "==== END set_static_ip.sh v4 ===="

#sleep 2
#/sbin/reboot
bash $MANAGER

