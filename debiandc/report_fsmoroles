#!/bin/bash

cd /usr/local/debiandc || exit 1
source common-value

REPORT_DIR="/tmp/debiandc-reports"
REPORT_NAME="fsmo-roles.html"
OUT_FILE="${REPORT_DIR}/${REPORT_NAME}"

have() { command -v "$1" >/dev/null 2>&1; }

h() {
  sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e 's/"/\&quot;/g' -e "s/'/\&#39;/g"
}

run_cmd() {
  local out rc
  out="$("$@" 2>&1)"; rc=$?
  if [ "$rc" -ne 0 ]; then
    printf "%s" "N/A (rc=$rc) - $out"
  else
    printf "%s" "$out"
  fi
}

generate_report() {
  mkdir -p "$REPORT_DIR" 2>/dev/null

  local date_now hostname_fqdn os_pretty samba_ver
  date_now="$(date -Is)"
  hostname_fqdn="$(run_cmd hostname -f)"
  os_pretty="$(run_cmd sh -lc '. /etc/os-release 2>/dev/null; echo "${PRETTY_NAME:-unknown}"')"

  samba_ver="N/A"
  if have samba; then
    samba_ver="$(run_cmd samba -V)"
  elif have smbd; then
    samba_ver="$(run_cmd smbd -V)"
  fi

  local fsmo domain_info
  fsmo="N/A"
  domain_info="N/A"

  if have samba-tool; then
    fsmo="$(run_cmd samba-tool fsmo show)"
    domain_info="$(run_cmd samba-tool domain info 127.0.0.1)"
  else
    fsmo="N/A (samba-tool not found)"
  fi

  cat >"$OUT_FILE" <<EOF
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DebianDC - FSMO Roles</title>
<style>
  body{
    margin:18px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height:1.35;
    background:#f6f7fb;
    color:#111827;
  }
  .container{max-width:1100px;margin:0 auto;}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;}
  .brand{display:flex;align-items:center;gap:10px;}
  .logo{width:12px;height:12px;border-radius:50%;background:#d32f2f;}
  h1{margin:0;font-size:20px;font-weight:900;}
  .meta{font-size:12px;color:#6b7280;}
  .card{
    margin-top:12px;
    padding:12px;
    border:1px solid #e5e7eb;
    border-radius:14px;
    background:#ffffff;
  }
  .section-title{
    margin:0 0 10px 0;
    font-size:15px;
    font-weight:950;
    padding-left:10px;
    border-left:4px solid #d32f2f;
  }
  .code{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px;
    background:#f3f4f6;
    color:#111827;
  }
  pre{
    margin:0;
    white-space:pre-wrap;
    word-break:break-word;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:12px;
    color:inherit;
  }
  .footer{margin-top:12px;font-size:12px;color:#6b7280;}
</style>
</head>
<body>
<div class="container">

  <div class="topbar">
    <div class="brand">
      <span class="logo"></span>
      <div>
        <h1>DebianDC — FSMO Roles</h1>
        <div class="meta">Generated: $(printf "%s" "$date_now" | h)</div>
      </div>
    </div>
    <div class="meta">Host: $(printf "%s" "$hostname_fqdn" | h) · OS: $(printf "%s" "$os_pretty" | h) · Samba: $(printf "%s" "$samba_ver" | h)</div>
  </div>

  <div class="card">
    <div class="section-title">FSMO Roles</div>
    <div class="code"><pre>$(printf "%s" "$fsmo" | h)</pre></div>
  </div>

  <div class="card">
    <div class="section-title">Domain Info (Context)</div>
    <div class="meta" style="margin-bottom:8px;">samba-tool domain info 127.0.0.1</div>
    <div class="code"><pre>$(printf "%s" "$domain_info" | h)</pre></div>
  </div>

  <div class="footer">Generated by <b>DebianDC Manager</b></div>

</div>
</body>
</html>
EOF
}

open_report() {
  if have netsurf-gtk; then
    netsurf-gtk "$OUT_FILE" >/dev/null 2>&1 || true
  else
    zenity --info --title="DebianDC Reports" --width=520 \
      --text="Report Generated:\n\n$OUT_FILE\n\Report Viewer Not Found!"
  fi
}

main() {
  if have zenity; then
    (
      echo "# FSMO Roles Report Generating.."
      generate_report
      echo "# Report prepared. Report Opening..."
      sleep 0.2
    ) | zenity --progress \
          --title="DebianDC Reports" \
          --text="FSMO Roles Report" \
          --pulsate \
          --auto-close \
          --no-cancel \
          --width=520
  else
    generate_report
  fi

  open_report
}

main "$@"

