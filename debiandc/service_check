#/bin/bash

cd /usr/local/debiandc
source common-value

# DNS Service Check
netstat -tulanp | grep 53 | grep samba | grep dns >> /dev/null

if [ "$?" = "1" ]; then
zenity --info --text="DNS Service is not working properly. \nIn this case; Kerberos ticket cannot be provided \nYou can refer to the DebianDC Handbook \n \nErrorCode:\n \nhttps://github.com/eesmer/DebianDC/blob/master/DebianDC-Handbook.md" --ellipsize
fi

# resolv.conf Check
ack 127.0.0.1 /etc/resolv.conf >> /dev/null
if [ ! "$?" = "0" ]; then
zenity --info --text="DC server must be specified in resolv.conf configuration. (127.0.0.1)\n\Otherwise, kerberos ticket cannot be provided.\n \nErrorCode:\n \nhttps://github.com/eesmer/DebianDC/blob/master/DebianDC-Handbook.md" --ellipsize
fi

# kerberos ticket is expired
if [ ! -f "/tmp/krb5cc_0" ]; then
        TICKET_TIME=0
else
        TICKET_TIME=$(ls -l /tmp/krb5cc_0 | awk '{print $8}' | cut -d ":" -f1)
fi
#EXPIRE_TIME=$(klist | grep "krbtgt" | awk '{print $4}' | cut -d ":" -f1)
NOW=$(printf "%(%H:%M)T" | cut -d ":" -f1)
PASS_TIME=$(expr $NOW - $TICKET_TIME)

if [ "$PASS_TIME" -gt "8" ]; then
        rm /tmp/krb5cc_0
        zenity --info --text="Kerberos Ticket Expired.\n\\nErrorCode:\n \nhttps://github.com/eesmer/DebianDC/blob/master/DebianDC-Handbook.md" --ellipsize
        #bash manager
fi

exit 1
