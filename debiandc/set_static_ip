#!/bin/bash

set -Eeuo pipefail

source /usr/local/debiandc/common-value

MANAGER="/usr/local/debiandc/manager"
CFG_D_FILE="/etc/network/interfaces.d/debiandcnw"
IFACES_FILE="/etc/network/interfaces"

LOG_DIR="/var/log/debiandc"
LOG_FILE="$LOG_DIR/set_static_ip.log"

mkdir -p "$LOG_DIR" || true
touch "$LOG_FILE" || true
chmod 600 "$LOG_FILE" 2>/dev/null || true

ts(){ date -Is; }
log(){ echo "[$(ts)] $*" >> "$LOG_FILE"; }

fatal(){
  local msg="$1"
  log "[FATAL] $msg"
  zenity --error --width="$WIDTH" --title="DebianDC Static IP" --text="$msg\n\nLog: $LOG_FILE" || true
  exit 1
}

on_err(){
  local ec=$?
  log "[ERR] Exit code: $ec (line $1)"
  local tail_txt
  tail_txt="$(tail -n 60 "$LOG_FILE" 2>/dev/null || true)"
  zenity --error --width="$WIDTH" --title="DebianDC Static IP - Error" \
    --text="Process finished with errors(exit=$ec).\n\nLast logs:\n$tail_txt\n\nLog: $LOG_FILE" || true
  exit "$ec"
}
trap 'on_err $LINENO' ERR

need_cmd(){
  command -v "$1" >/dev/null 2>&1 || fatal "Command not found!: $1"
}

# for DebianDC install/config
IFDOWN="$(command -v ifdown 2>/dev/null || true)"
IFUP="$(command -v ifup 2>/dev/null || true)"
[[ -n "$IFDOWN" ]] || IFDOWN="/sbin/ifdown"
[[ -n "$IFUP" ]]   || IFUP="/sbin/ifup"

list_ifaces(){
  ip -o link show | awk -F': ' '{print $2}' | grep -v '^lo$' | sort -u
}

valid_ipv4(){
  local ip="$1"
  [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || return 1
  IFS='.' read -r a b c d <<<"$ip"
  for n in "$a" "$b" "$c" "$d"; do
    [[ "$n" -ge 0 && "$n" -le 255 ]] || return 1
  done
  return 0
}

valid_netmask(){
  valid_ipv4 "$1"
}

normalize_dns_list(){
  echo "$1" | tr ',' ' ' | xargs
}

write_atomic(){
  local target="$1"
  local tmp
  tmp="$(mktemp)"
  cat >"$tmp"
  chmod 644 "$tmp"
  mv -f "$tmp" "$target"
}

backup_file(){
  local f="$1"
  [[ -f "$f" ]] || return 0
  cp -a "$f" "${f}.bak.$(date +%Y%m%d-%H%M%S)"
}

ensure_interfaces_include() {
  local f="$IFACES_FILE"
  [[ -f "$f" ]] || touch "$f"

  if ! grep -qE '^[[:space:]]*source[[:space:]]+/etc/network/interfaces\.d/\*$' "$f"; then
    log "Adding interfaces.d include line to $f"
    printf "\n# DebianDC: include per-interface configs\nsource /etc/network/interfaces.d/*\n" >> "$f"
  else
    log "interfaces.d include already present"
  fi
}

remove_dhcp_stanzas(){
  local f="$1"
  [[ -f "$f" ]] || return 0
  backup_file "$f"

  awk '
    BEGIN {skip=0}
    /^[[:space:]]*iface[[:space:]].*[[:space:]]inet[[:space:]]dhcp[[:space:]]*$/ {skip=1; next}
    /^[[:space:]]*iface[[:space:]]/ {skip=0}
    /^[[:space:]]*auto[[:space:]]/ {skip=0}
    /^[[:space:]]*allow-hotplug[[:space:]]/ {skip=0}
    skip==1 && /^[[:space:]]+/ {next}
    skip==1 && /^[[:space:]]*$/ {skip=0; next}
    {print}
  ' "$f" > "${f}.tmp"

  mv -f "${f}.tmp" "$f"
}

write_debiandcnw(){
  local iface="$1" ipaddr="$2" netmask="$3" gw="$4" dns_list="$5"
  mkdir -p /etc/network/interfaces.d
  backup_file "$CFG_D_FILE"
  {
    echo "auto $iface"
    echo "iface $iface inet static"
    echo "    address $ipaddr"
    echo "    netmask $netmask"
    [[ -n "$gw" ]] && echo "    gateway $gw"
    echo "    dns-nameservers $dns_list"
  } | write_atomic "$CFG_D_FILE"
  log "Wrote $CFG_D_FILE"
}

write_resolv_conf() {
  local dns_list="$1"
  # is symlink
  [[ -L /etc/resolv.conf ]] && rm -f /etc/resolv.conf

  if command -v lsattr >/dev/null 2>&1 && lsattr /etc/resolv.conf 2>/dev/null | grep -q '\-i\-'; then
    chattr -i /etc/resolv.conf 2>/dev/null || true
  fi
  {
    echo "# Generated by DebianDC set_static_ip.sh"
    for dns in $dns_list; do
      valid_ipv4 "$dns" || fatal "DNS IP Not Valid: $dns"
      echo "nameserver $dns"
    done
  } > /etc/resolv.conf
  chmod 644 /etc/resolv.conf
  log "Wrote /etc/resolv.conf"
  # for verify
  local first
  first="$(awk '/^nameserver/{print $2; exit}' /etc/resolv.conf 2>/dev/null || true)"
  local expected
  expected="$(echo "$dns_list" | awk '{print $1}')"
  if [[ "$first" != "$expected" ]]; then
    log "resolv.conf immediately changed (first=$first expected=$expected). Locking with chattr +i"
    # immutable lock
    command -v chattr >/dev/null 2>&1 || fatal "resolv.conf overwrite chattr command not found. Package:e2fsprogs"
    chattr +i /etc/resolv.conf || fatal "chattr +i failed"
  fi
}

get_current_ipv4_cidr(){
  local iface="$1"
  ip -4 -o addr show dev "$iface" | awk '{print $4}' | head -n1
}

apply_iface(){
  local iface="$1"
  log "Applying interface: $iface (flush + ifdown/ifup)"
  # Old address cleanup
  ip addr flush dev "$iface" || true
  "$IFDOWN" --force "$iface" >>"$LOG_FILE" 2>&1 || true
  sleep 1
  "$IFUP" "$iface" >>"$LOG_FILE" 2>&1 || true
  sleep 1
}

return_to_manager(){
  if [[ -x "$MANAGER" ]]; then
    exec "$MANAGER"
  fi
  zenity --warning --width="$WIDTH" --title="DebianDC Static IP" \
    --text="manager script not found: $MANAGER" || true
  exit 0
}

log "==== START set_static_ip.sh ===="
need_cmd zenity
need_cmd ip
# for DebianDC install and settings
[[ -x "$IFDOWN" ]] || fatal "ifdown command not found: $IFDOWN (package: ifupdown)"
[[ -x "$IFUP" ]]   || fatal "ifup command not found: $IFUP (package: ifupdown)"

IFACE_LIST="$(list_ifaces | paste -sd'|' -)"
[[ -n "$IFACE_LIST" ]] || fatal "NIC Not Found!!"

CHOICE="$(zenity --forms --title="DebianDC Static IP Settings" --text="Static IP" \
  --width="$WIDTH" --height="$HEIGHT" \
  --add-combo="Interface" --combo-values="$IFACE_LIST" \
  --add-entry="IP Address (example: 10.1.1.11)" \
  --add-entry="Netmask (example: 255.255.255.0)" \
  --add-entry="Gateway (optional, example: 10.1.1.1)" \
  --add-entry="DNS Server(s) (example: 10.1.1.10,8.8.8.8)")" || exit 0

IFS='|' read -r INTERFACE IPADDRESS NETMASK GATEWAY DNSSERVER <<<"$CHOICE"

INTERFACE="$(echo "${INTERFACE:-}" | xargs)"
IPADDRESS="$(echo "${IPADDRESS:-}" | xargs)"
NETMASK="$(echo "${NETMASK:-}" | xargs)"
GATEWAY="$(echo "${GATEWAY:-}" | xargs)"
DNSSERVER="$(echo "${DNSSERVER:-}" | xargs)"

[[ -n "$INTERFACE" && -n "$IPADDRESS" && -n "$NETMASK" && -n "$DNSSERVER" ]] \
  || fatal "Please fill in all fields.( IP / Netmask / DNS )"

valid_ipv4 "$IPADDRESS" || fatal "IP Address not valid: $IPADDRESS"
valid_netmask "$NETMASK" || fatal "Netmask not valid: $NETMASK"
if [[ -n "$GATEWAY" ]]; then
  valid_ipv4 "$GATEWAY" || fatal "Gateway Address not valid: $GATEWAY"
fi

#####function create_debiandcnw(){
ifconfig $INTERFACE down
sleep 1
cat > /etc/network/interfaces.d/debiandcnw << EOF
auto $INTERFACE
iface $INTERFACE inet static
address $IPADDRESS
netmask $NETMASK
gateway $GATEWAY
EOF
chmod 644 /etc/network/interfaces.d/debiandcnw
sed -i /$INTERFACE/d /etc/network/interfaces
ifconfig $INTERFACE up
##################################}

echo "50" ; sleep 1

ifdown $INTERFACE
sleep 1
ifup $INTERFACE

echo "99" ; sleep 1

zenity --info --text "The new ip address: $IPADDRESS" --ellipsize #--width 350 --height 100
) |
zenity --progress \
  --title="IP Config" \
  --text="Set Static IP Address" \
  --percentage=0 \
  --auto-close

if [ "$?" = -1 ] ; then
        zenity --error \
          --text="Set IP Address process canceled."
fi

bash manager
