#!/bin/bash

set -Eeuo pipefail

source /usr/local/debiandc/common-value

MANAGER="/usr/local/debiandc/manager"
CFG_D_FILE="/etc/network/interfaces.d/debiandcnw"
IFACES_FILE="/etc/network/interfaces"

LOG_DIR="/var/log/debiandc"
LOG_FILE="$LOG_DIR/set_static_ip.log"

mkdir -p "$LOG_DIR" || true
touch "$LOG_FILE" || true
chmod 600 "$LOG_FILE" 2>/dev/null || true

ts(){ date -Is; }
log(){ echo "[$(ts)] $*" >> "$LOG_FILE"; }

fatal(){
  local msg="$1"
  log "[FATAL] $msg"
  zenity --error --width="$WIDTH" --title="DebianDC Static IP" --text="$msg\n\nLog: $LOG_FILE" || true
  exit 1
}

on_err(){
  local ec=$?
  log "[ERR] Exit code: $ec (line $1)"
  local tail_txt
  tail_txt="$(tail -n 60 "$LOG_FILE" 2>/dev/null || true)"
  zenity --error --width="$WIDTH" --title="DebianDC Static IP - Error" \
    --text="Process finished with errors(exit=$ec).\n\nLast logs:\n$tail_txt\n\nLog: $LOG_FILE" || true
  exit "$ec"
}
trap 'on_err $LINENO' ERR

need_cmd(){
  command -v "$1" >/dev/null 2>&1 || fatal "Command not found!: $1"
}

# for DebianDC install/config
IFDOWN="$(command -v ifdown 2>/dev/null || true)"
IFUP="$(command -v ifup 2>/dev/null || true)"
[[ -n "$IFDOWN" ]] || IFDOWN="/sbin/ifdown"
[[ -n "$IFUP" ]]   || IFUP="/sbin/ifup"

list_ifaces(){
  ip -o link show | awk -F': ' '{print $2}' | grep -v '^lo$' | sort -u
}

valid_ipv4(){
  local ip="$1"
  [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || return 1
  IFS='.' read -r a b c d <<<"$ip"
  for n in "$a" "$b" "$c" "$d"; do
    [[ "$n" -ge 0 && "$n" -le 255 ]] || return 1
  done
  return 0
}

valid_netmask(){
  valid_ipv4 "$1"
}

normalize_dns_list(){
  echo "$1" | tr ',' ' ' | xargs
}

write_atomic(){
  local target="$1"
  local tmp
  tmp="$(mktemp)"
  cat >"$tmp"
  chmod 644 "$tmp"
  mv -f "$tmp" "$target"
}


#####function create_debiandcnw(){
ifconfig $INTERFACE down
sleep 1
cat > /etc/network/interfaces.d/debiandcnw << EOF
auto $INTERFACE
iface $INTERFACE inet static
address $IPADDRESS
netmask $NETMASK
gateway $GATEWAY
EOF
chmod 644 /etc/network/interfaces.d/debiandcnw
sed -i /$INTERFACE/d /etc/network/interfaces
ifconfig $INTERFACE up
##################################}

echo "50" ; sleep 1

ifdown $INTERFACE
sleep 1
ifup $INTERFACE

echo "99" ; sleep 1

zenity --info --text "The new ip address: $IPADDRESS" --ellipsize #--width 350 --height 100
) |
zenity --progress \
  --title="IP Config" \
  --text="Set Static IP Address" \
  --percentage=0 \
  --auto-close

if [ "$?" = -1 ] ; then
        zenity --error \
          --text="Set IP Address process canceled."
fi

bash manager
