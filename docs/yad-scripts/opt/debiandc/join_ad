#!/bin/bash
# /opt/debiandc/join_ad.sh

set -euo pipefail

cd /opt/debiandc/ || exit 1
source common-value
: "${YAD_OPTS:=}"

if CHOICE=$(yad $YAD_OPTS --form \
    --title="Join to Existing AD (ADC)" \
    --text="<b>Mevcut domaine Additional Domain Controller (ADC) olarak katılım</b>\nLütfen bilgileri girin." \
    --separator="|" \
    --field="Hostname (Short, Without FQDN):" "DEBIANDC02" \
    --field="DNS Server (Domain Controller IP Address):" "" \
    --field="Domain Name (FQDN - example.lan):" "example.lan" \
    --field="Administrator Password:H" "" \
    --button="Continue!gtk-ok:0" --button="Cancel!gtk-cancel:1"); then

  [[ -z "$CHOICE" ]] && exec bash "$MAIN"

else
  cd "$BASE_DIR"
  exec bash "$MAIN"
fi

IFS="|" read -r HNAME DNSSRV DOMAIN PASSWORD <<< "$CHOICE"

ERR=""
[[ -z "$HNAME" ]]    && ERR+="\n- Hostname"
[[ -z "$DNSSRV" ]]   && ERR+="\n- DNS Server"
[[ -z "$DOMAIN" ]]   && ERR+="\n- Domain Name"
[[ -z "$PASSWORD" ]] && ERR+="\n- Administrator Password"

if [[ -n "$ERR" ]]; then
  yad $YAD_OPTS --error \
    --title="Missing Fields" \
    --text="Please fill in:$ERR" \
    --button="OK!gtk-ok:0"
  bash "$MAIN"
  exit 0
fi

hostnamectl set-hostname "${HNAME}.${DOMAIN}"
if [[ -f /etc/resolv.conf ]]; then
  cp -a /etc/resolv.conf /etc/resolv.conf.bak.joinad || true
fi
{
  echo "domain ${DOMAIN}"
  echo "search ${DOMAIN}"
  echo "nameserver ${DNSSRV}"
} > /etc/resolv.conf

if grep -q '^127\.0\.1\.1' /etc/hosts; then
  sed -i "s/^127\.0\.1\.1.*/127.0.1.1 ${HNAME}.${DOMAIN} ${HNAME}/" /etc/hosts
else
  echo "127.0.1.1 ${HNAME}.${DOMAIN} ${HNAME}" >> /etc/hosts
fi

if ! ping -c 1 -W 2 "${DOMAIN}" >/dev/null 2>&1; then
  yad $YAD_OPTS --error --text="$DOMAIN Ping did not respond or the domain name could not be resolved.\nDNS: ${DNSSRV}" \
  --button="OK!gtk-ok:0"
  bash "$MAIN"
  exit 0
else
  yad $YAD_OPTS --info --text="Ok,\n${DOMAIN} found. The join process will begin."
fi

echo DOMAIN=$(echo "$DOMAIN" | tr '[:lower:]' '[:upper:]') >> $BASE_DIR/common-value
echo HNAME=$(echo "${HNAME}.${DOMAIN}" | tr '[:lower:]' '[:upper:]') >> $BASE_DIR/common-value

