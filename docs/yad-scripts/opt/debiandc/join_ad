#!/bin/bash
# /opt/debiandc/join_ad.sh

set -euo pipefail

cd /opt/debiandc/ || exit 1
source common-value
: "${YAD_OPTS:=}"

if CHOICE=$(yad $YAD_OPTS --form \
    --title="Join to Existing AD (ADC)" \
    --text="<b>Mevcut domaine Additional Domain Controller (ADC) olarak katılım</b>\nLütfen bilgileri girin." \
    --separator="|" \
    --field="Hostname (Short, Without FQDN):" "DEBIANDC02" \
    --field="DNS Server (Domain Controller IP Address):" "" \
    --field="Domain Name (FQDN - example.lan):" "example.lan" \
    --field="Administrator Password:H" "" \
    --button="Continue!gtk-ok:0" --button="Cancel!gtk-cancel:1"); then

  [[ -z "$CHOICE" ]] && exec bash "$MAIN"

else
  cd "$BASE_DIR"
  exec bash "$MAIN"
fi

IFS="|" read -r HNAME DNSSRV DOMAIN PASSWORD <<< "$CHOICE"

ERR=""
[[ -z "$HNAME" ]]    && ERR+="\n- Hostname"
[[ -z "$DNSSRV" ]]   && ERR+="\n- DNS Server"
[[ -z "$DOMAIN" ]]   && ERR+="\n- Domain Name"
[[ -z "$PASSWORD" ]] && ERR+="\n- Administrator Password"

if [[ -n "$ERR" ]]; then
  yad $YAD_OPTS --error \
    --title="Missing Fields" \
    --text="Please fill in:$ERR" \
    --button="OK!gtk-ok:0"
  bash "$MAIN"
  exit 0
fi

hostnamectl set-hostname "${HNAME}.${DOMAIN}"
if [[ -f /etc/resolv.conf ]]; then
  cp -a /etc/resolv.conf /etc/resolv.conf.bak.joinad || true
fi
{
  echo "domain ${DOMAIN}"
  echo "search ${DOMAIN}"
  echo "nameserver ${DNSSRV}"
} > /etc/resolv.conf

if grep -q '^127\.0\.1\.1' /etc/hosts; then
  sed -i "s/^127\.0\.1\.1.*/127.0.1.1 ${HNAME}.${DOMAIN} ${HNAME}/" /etc/hosts
else
  echo "127.0.1.1 ${HNAME}.${DOMAIN} ${HNAME}" >> /etc/hosts
fi

if ! ping -c 1 -W 2 "${DOMAIN}" >/dev/null 2>&1; then
  yad $YAD_OPTS --error --text="$DOMAIN Ping did not respond or the domain name could not be resolved.\nDNS: ${DNSSRV}" \
  --button="OK!gtk-ok:0"
  bash "$MAIN"
  exit 0
else
  yad $YAD_OPTS --info --text="Ok,\n${DOMAIN} found. The join process will begin."
fi

echo DOMAIN=$(echo "$DOMAIN" | tr '[:lower:]' '[:upper:]') >> $BASE_DIR/common-value
echo HNAME=$(echo "${HNAME}.${DOMAIN}" | tr '[:lower:]' '[:upper:]') >> $BASE_DIR/common-value

(
  echo "5";  echo "# Packages are being installed..."
  export DEBIAN_FRONTEND=noninteractive
  PACK_INSTALL=FALSE
  if apt-get update -y && apt-get -y install bind9 bind9utils dnsutils krb5-user samba --install-recommends winbind; then
    PACK_INSTALL=TRUE
  fi
  if [[ "$PACK_INSTALL" != "TRUE" ]]; then
    echo "100"; echo "# Mandatory packages could not be installed. Check your internet or repository access connection."
    exit 1
  fi

  echo "20"; echo "# Cleaning smb.conf..."
  rm -f /etc/samba/smb.conf || true

  echo "40"; echo "# The machine is joined to the Domain as a DC..."
  DOMAIN_JOIN=FALSE
  if samba-tool domain join "$DOMAIN" DC --dns-backend=BIND9_DLZ -U Administrator --password="$PASSWORD"; then
    DOMAIN_JOIN=TRUE
  fi
  if [[ "$DOMAIN_JOIN" != "TRUE" ]]; then
    echo "100"; echo "# Domain join failed. Check your login information."
    exit 1
  fi

  echo "55"; echo "# BIND defaults..."
  rm -f /etc/default/bind9 || true
  cat > /etc/default/bind9 << 'EOF'
RESOLVCONF=no
OPTIONS="-u bind -4"
EOF
  chmod 644 /etc/default/bind9

  echo "65"; echo "# named.conf.local preparing..."
  echo 'include "/var/lib/samba/bind-dns/named.conf";' > /etc/bind/named.conf.local

  rm -f /etc/bind/named.conf.options || true

  SERVER_IP=$(ip r | grep link | grep src | awk '{for(i=1;i<=NF;i++) if($i=="src"){print $(i+1); exit}}')
  INTERNAL1=127.0.0.0/8
  INTERNAL2=$(ip r | grep link | grep src | awk '{print $1; exit}')
  SUBNET=$(ip r | grep link | grep src | awk -F'[/ ]' '{print $1"/"$2; exit}')
  PDC=$(nslookup "$DOMAIN" 2>/dev/null | awk -F': ' '/Server:/{print $2; exit}')

  cat > /etc/bind/named.conf.options << EOF
acl internals {
$INTERNAL1;
$INTERNAL2;
};

options {
  directory "/var/cache/bind";
  auth-nxdomain yes;
  empty-zones-enable no;
  notify no;
  minimal-responses yes;

  dnssec-validation no;
  dnssec-enable no;
  dnssec-lookaside no;

  allow-transfer { $PDC; };
  allow-query { internals; };
  allow-query-cache { "internals"; };
  allow-recursion { internals; };

  listen-on-v6 { none; };
  sortlist { $SERVER_IP; };
  tkey-gssapi-keytab "/var/lib/samba/bind-dns/dns.keytab";
};
EOF

  chmod 644 /etc/bind/named.conf.options
  chmod 644 /var/lib/samba/bind-dns/named.conf || true
  chown root:bind /etc/bind/named.conf.local
  chmod 644 /etc/bind/named.conf.local
  chgrp bind /var/lib/samba/bind-dns/ || true

  echo "80"; echo "# Services are being activeted..."
  systemctl unmask samba-ad-dc.service || true
  systemctl enable samba-ad-dc.service || true
  systemctl start samba-ad-dc.service || true
  systemctl restart samba-ad-dc.service || true
  systemctl restart bind9.service || true

  echo "95"; echo "# Checking Configuration..."
  samba-tool drs showrepl 127.0.0.1 >/dev/null 2>&1 || true
  samba-tool domain level show        >/dev/null 2>&1 || true

  echo "100"; echo "# Done"
) | yad $YAD_OPTS --progress \
     --title="Join to Existing AD (ADC)" \
     --percentage=0 --auto-close --no-buttons

yad $YAD_OPTS --info --title="Success" \
  --text="Makine <b>${HNAME}.${DOMAIN}</b>, <b>${DOMAIN}</b> to the domain <b>ADDC</b> added.\n\nThe system will reboot"

reboot

