#!/bin/bash
set -Eeuo pipefail

# Logs:
LOG_DIR="/var/log/debiandc"
LOG_MAIN="${LOG_DIR}/ad-bind13-install.log"
LOG_PROV="${LOG_DIR}/ad-bind13-provision.log"

# ---------- UI ----------
die() { zenity --error --width=720 --height=260 --text="$1"; exit 1; }
info(){ zenity --info  --width=720 --height=220 --text="$1"; }
ask() { zenity --question --width=720 --height=280 --text="$1"; }
MANAGER_BIN="/usr/local/debiandc/manager"

# AD Install
while true; do
if ! HNAME=$(zenity --entry --title="DC Hostname" --text="Enter DC Machine Hostname (e.g., DC01)" --width=400); then
	zenity --info \
	--title="Operation Canceled" \
	--text="Hostname input was canceled.\nReturning to DebianDC Manager." \
	--width=350
	#pgrep -f '/usr/local/bin/manager\.sh' >/dev/null || /usr/local/bin/manager.sh &
	pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
	exit 1
fi
HNAME="$(printf '%s' "$HNAME" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
if [ -z "$HNAME" ]; then
	zenity --error \
        --title="Hostname Required" \
        --text="Hostname cannot be empty. Please enter a hostname (e.g., DC01)." \
        --width=380
        continue
fi
# Long Check
if [ "${#HNAME}" -gt 15 ]; then
        zenity --error \
        --title="Invalid Hostname Length" \
        --text="Hostname must be between 1 and 15 characters." \
        --width=380
        continue
fi
# Regex Check - letters/numbers / dash can use / It cannot start/end with dash.
if ! [[ "$HNAME" =~ ^[A-Za-z0-9]([A-Za-z0-9-]*[A-Za-z0-9])?$ ]]; then
        zenity --error \
        --title="Invalid Hostname" \
        --text="Hostname may contain only letters, numbers, and hyphens (-).\nIt cannot start or end with a hyphen." \
        --width=420
        continue
fi
break
done

# Get REALM/DOMAIN
while true; do
  if ! REALM=$(zenity --entry \
      --title="Domain Name (Realm)" \
      --text="Enter Domain Name (e.g., EXAMPLE.LOC)" \
      --width=420); then

    zenity --info \
      --title="Operation Canceled" \
      --text="Domain input was canceled.\nReturning to DebianDC Manager." \
      --width=360

    pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
    exit 1
  fi

  # Trim
  REALM="$(printf '%s' "$REALM" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

  if [ -z "$REALM" ]; then
    zenity --error \
      --title="Domain Required" \
      --text="Domain name cannot be empty. Example: EXAMPLE.LOC" \
      --width=420
    continue
  fi

  # for Uppercase
  REALM="$(printf '%s' "$REALM" | tr '[:lower:]' '[:upper:]')"

  if ! [[ "$REALM" =~ ^[A-Z0-9]+(\.[A-Z0-9]+)+$ ]]; then
    zenity --error \
      --title="Invalid Domain Format" \
      --text="Use only letters, numbers and dots.\nExample: EXAMPLE.LOC\nNo spaces, underscores, or hyphens." \
      --width=440
    continue
  fi

  if [[ "$REALM" == .* || "$REALM" == *. || "$REALM" == *..* ]]; then
    zenity --error \
      --title="Invalid Domain Format" \
      --text="Domain cannot start/end with a dot and cannot contain consecutive dots." \
      --width=440
    continue
  fi

  # DNS limits
  if [ "${#REALM}" -gt 253 ]; then
    zenity --error \
      --title="Domain Too Long" \
      --text="Domain name is too long (max 253 characters)." \
      --width=420
    continue
  fi
  bad_label=0
  IFS='.' read -r -a _labels <<< "$REALM"
  for _l in "${_labels[@]}"; do
    if [ -z "$_l" ] || [ "${#_l}" -gt 63 ]; then
      bad_label=1
      break
    fi
  done
  if [ "$bad_label" -eq 1 ]; then
    zenity --error \
      --title="Invalid Domain Label" \
      --text="Each domain part between dots must be 1â€“63 characters.\nExample: EXAMPLE.LOC" \
      --width=460
    continue
  fi
  # Create NetBIOS Name
  NETBIOS_DOMAIN="$(printf '%s' "$REALM" | cut -d'.' -f1)"
  NETBIOS_DOMAIN="$(printf '%s' "$NETBIOS_DOMAIN" | tr '[:lower:]' '[:upper:]')"
  NETBIOS_DOMAIN="${NETBIOS_DOMAIN:0:15}"
  NETBIOS_DOMAIN="$(printf '%s' "$NETBIOS_DOMAIN" | sed 's/[^A-Z0-9]//g')"
  if [ -z "$NETBIOS_DOMAIN" ]; then
	  zenity --error \
		  --title="Invalid NetBIOS Domain" \
		  --text="Unable to derive a valid NetBIOS domain name from realm:\n\n$REALM" \
		  --width=460
	  pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
	  exit 1
  fi
  break
done

  while true; do
  if ! ADMIN_PASS_1=$(zenity --password \
      --title="Administrator Password" \
      --text="Enter Administrator password for Samba AD (e.g., for 'Administrator')." \
      --width=420); then
    zenity --info \
      --title="Operation Canceled" \
      --text="Password input was canceled.\nReturning to DebianDC Manager." \
      --width=360
    pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
    exit 1
  fi
  if [ -z "$ADMIN_PASS_1" ]; then
    zenity --error \
      --title="Password Required" \
      --text="Password cannot be empty." \
      --width=380
    continue
  fi
  if [ "${#ADMIN_PASS_1}" -lt 8 ]; then
    zenity --error \
      --title="Weak Password" \
      --text="Password must be at least 8 characters." \
      --width=380
    continue
  fi
  
  if ! ADMIN_PASS_2=$(zenity --password \
      --title="Confirm Password" \
      --text="Re-enter the Administrator password to confirm." \
      --width=420); then
    zenity --info \
      --title="Operation Canceled" \
      --text="Password confirmation was canceled.\nReturning to DebianDC Manager." \
      --width=380
    pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
    exit 1
  fi
  
  if [ "$ADMIN_PASS_1" != "$ADMIN_PASS_2" ]; then
    zenity --error \
      --title="Password Mismatch" \
      --text="Passwords do not match. Please try again." \
      --width=420
    unset ADMIN_PASS_1 ADMIN_PASS_2
    continue
  fi
  ADMIN_PASS="$ADMIN_PASS_1"
  unset ADMIN_PASS_1 ADMIN_PASS_2

  break
done

while true; do
  if ! DNS_FORWARDER=$(zenity --entry \
      --title="DNS Forwarder" \
      --text="Enter DNS forwarder IP address(es).\nExample: 1.1.1.1 or 1.1.1.1,8.8.8.8" \
      --width=480); then

    zenity --info \
      --title="Operation Canceled" \
      --text="DNS forwarder input was canceled.\nReturning to DebianDC Manager." \
      --width=380

    pgrep -f "^${MANAGER_BIN}$" >/dev/null || "$MANAGER_BIN" &
    exit 1
  fi
  DNS_FORWARDER="$(printf '%s' "$DNS_FORWARDER" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
  
  if [ -z "$DNS_FORWARDER" ]; then
    zenity --error \
      --title="DNS Forwarder Required" \
      --text="DNS forwarder cannot be empty." \
      --width=380
    continue
  fi

  if [[ "$DNS_FORWARDER" =~ [[:space:]] ]]; then
    zenity --error \
      --title="Invalid Format" \
      --text="Do not use spaces.\nUse comma-separated IP addresses.\nExample: 1.1.1.1,8.8.8.8" \
      --width=460
    continue
  fi

  valid=1
  IFS=',' read -r -a _ips <<< "$DNS_FORWARDER"
  for ip in "${_ips[@]}"; do
    if ! [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
      valid=0
      break
    fi
    IFS='.' read -r o1 o2 o3 o4 <<< "$ip"
    for o in "$o1" "$o2" "$o3" "$o4"; do
      if [ "$o" -gt 255 ]; then
        valid=0
        break 2
      fi
    done
  done
  
  if [ "$valid" -ne 1 ]; then
    zenity --error \
      --title="Invalid IP Address" \
      --text="One or more DNS forwarder IP addresses are invalid.\n\nExample:\n1.1.1.1\nor\n1.1.1.1,8.8.8.8" \
      --width=480
    continue
  fi

DNS_BACKEND="BIND9_DLZ"

