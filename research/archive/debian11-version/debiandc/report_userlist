#!/bin/bash

# ----------------------------------------------------------------------------------------------------------------------
# DebianDC Scripts
# Name        : report_userlist
# Purpose     : Detailed Domain Users report (summary table + enabled/disabled split + full user show output).
# UI          : zenity progress + netsurf-gtk viewer
# Requires    : samba-tool, zenity, netsurf-gtk, /usr/local/debiandc/common-value
# Called from : Reports
# ----------------------------------------------------------------------------------------------------------------------

cd /usr/local/debiandc 2>/dev/null || exit 1
. ./common-value 2>/dev/null

REPORT_DIR="/tmp"
DETAIL_DIR="${REPORT_DIR}/userdetails"
REPORT_NAME="detailed-user-list.html"
OUT_FILE="${REPORT_DIR}/${REPORT_NAME}"

have() { command -v "$1" >/dev/null 2>&1; }

h() {
  sed -e 's/&/\&amp;/g' \
      -e 's/</\&lt;/g' \
      -e 's/>/\&gt;/g' \
      -e 's/"/\&quot;/g' \
      -e "s/'/\&#39;/g"
}

# Extract "attr:" lines from samba-tool user show output
get_attr() {
  # $1=attr name, reads from stdin
  # prints value after first colon
  awk -v key="$1" '
    BEGIN{IGNORECASE=1}
    $0 ~ ("^" key ":[[:space:]]*") {
      sub("^[^:]+:[[:space:]]*", "", $0);
      print $0;
      exit
    }'
}

is_disabled_from_uac() {
  # returns 0 if disabled, 1 otherwise
  # uses numeric userAccountControl bit 2
  local uac="$1"
  # If uac isn't numeric -> treat as enabled (return 1)
  case "$uac" in
    ''|*[!0-9]*) return 1 ;;
  esac
  if [ $((uac & 2)) -ne 0 ]; then
    return 0
  fi
  return 1
}

light_css() {
cat <<'CSS'
<style>
  body{
    margin:18px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height:1.35;
    background:#f6f7fb;
    color:#111827;
  }
  .container{max-width:1100px;margin:0 auto;}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;}
  .brand{display:flex;align-items:center;gap:10px;}
  .logo{width:12px;height:12px;border-radius:50%;background:#d32f2f;}
  h1{margin:0;font-size:20px;font-weight:900;}
  .meta{font-size:12px;color:#6b7280;}

  .card{
    margin-top:12px;
    padding:12px;
    border:1px solid #e5e7eb;
    border-radius:14px;
    background:#ffffff;
  }
  .section-title{
    margin:0 0 10px 0;
    font-size:15px;
    font-weight:950;
    padding-left:10px;
    border-left:4px solid #d32f2f;
  }

  table{width:100%;border-collapse:collapse;}
  td, th{vertical-align:top;padding:8px 8px;border-top:1px solid #eef0f3;text-align:left;}
  thead th{border-top:0;}
  th{font-size:12px;color:#6b7280;font-weight:900;}
  tr:first-child td{border-top:0;}

  .code{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px;
    background:#f3f4f6;
    color:#111827;
  }
  pre{
    margin:0;
    white-space:pre-wrap;
    word-break:break-word;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:12px;
    color:inherit;
  }

  .pill{
    display:inline-block;
    padding:2px 10px;
    border-radius:999px;
    background:#fff;
    border:1px solid #e5e7eb;
    font-size:12px;
    font-weight:900;
    color:#111827;
  }

  .badge-ok{border-color:#c8e6c9;background:#e8f5e9;}
  .badge-bad{border-color:#ffcdd2;background:#ffebee;}

  .footer{margin-top:12px;font-size:12px;color:#6b7280;}
  .hr{height:1px;background:#eef0f3;border:0;margin:10px 0;}
  .user-title{font-weight:950;color:#111827;margin-bottom:6px;}
</style>
CSS
}

generate_report() {
  mkdir -p "$REPORT_DIR" "$DETAIL_DIR" 2>/dev/null

  local date_now hostname_fqdn os_pretty samba_ver
  date_now="$(date -Is)"
  hostname_fqdn="$(hostname -f 2>/dev/null || hostname 2>/dev/null || echo unknown)"
  os_pretty="$(sh -lc '. /etc/os-release 2>/dev/null; echo "${PRETTY_NAME:-unknown}"' 2>/dev/null || echo unknown)"

  samba_ver="N/A"
  if have samba; then
    samba_ver="$(samba -V 2>/dev/null || true)"
  elif have smbd; then
    samba_ver="$(smbd -V 2>/dev/null || true)"
  fi

  if ! have samba-tool; then
    # Minimal HTML with error
    cat >"$OUT_FILE" <<EOF
<!doctype html><html lang="tr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DebianDC - Detailed User List</title>
$(light_css)
</head><body><div class="container">
<div class="topbar"><div class="brand"><span class="logo"></span><div><h1>DebianDC — Detailed Domain Users Report</h1><div class="meta">Generated: $(printf "%s" "$date_now" | h)</div></div></div></div>
<div class="card"><div class="section-title">Error</div><div class="code"><pre>N/A (samba-tool not found)</pre></div></div>
<div class="footer">Generated by <b>DebianDC Manager</b></div>
</div></body></html>
EOF
    return 0
  fi

  # user list
  local users_raw total
  users_raw="$(samba-tool user list 2>/dev/null | sed '/^[[:space:]]*$/d')"
  total="$(printf "%s\n" "$users_raw" | wc -l | tr -d ' ')"
  [ -z "$total" ] && total=0

  # Collect details once per user into files, build summary rows and enabled/disabled lists
  local enabled_list disabled_list
  enabled_list=""
  disabled_list=""

  local summary_rows
  summary_rows="$(mktemp /tmp/debiandc_user_summary.XXXXXX)"
  : >"$summary_rows"

  local i=0
  while IFS= read -r u; do
    [ -z "$u" ] && continue
    i=$((i+1))

    # progress update for zenity pipe
    if [ "${total:-0}" -gt 0 ]; then
      pct=$(( (i * 90) / total ))
    else
      pct=10
    fi
    echo "$pct"
    echo "# user detect: $u ($i/$total)"

    detail_file="${DETAIL_DIR}/${u}.txt"
    samba-tool user show "$u" >"$detail_file" 2>&1 || true

    # Parse fields for summary
    uac="$(cat "$detail_file" | get_attr "userAccountControl")"
    mail="$(cat "$detail_file" | get_attr "mail")"
    uidn="$(cat "$detail_file" | get_attr "uidNumber")"
    lastlogon="$(cat "$detail_file" | get_attr "lastLogonTimestamp")"
    desc="$(cat "$detail_file" | get_attr "description")"

    enabled="YES"
    badge="badge-ok"
    if is_disabled_from_uac "$uac"; then
      enabled="NO"
      badge="badge-bad"
      disabled_list="${disabled_list}
$u"
    else
      enabled_list="${enabled_list}
$u"
    fi

    # fallbacks
    [ -z "$uidn" ] && uidn="N/A"
    [ -z "$mail" ] && mail="N/A"
    [ -z "$lastlogon" ] && lastlogon="N/A"
    [ -z "$desc" ] && desc=""

    # Append summary row (HTML later; escape now is OK too)
    printf '<tr><td><b>%s</b></td><td><span class="pill %s">%s</span></td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n' \
      "$(printf "%s" "$u" | h)" \
      "$badge" \
      "$(printf "%s" "$enabled" | h)" \
      "$(printf "%s" "$uidn" | h)" \
      "$(printf "%s" "$mail" | h)" \
      "$(printf "%s" "$lastlogon" | h)" \
      "$(printf "%s" "$desc" | h)" \
      >>"$summary_rows"

  done <<<"$users_raw"

  echo "95"
  echo "# Users Report Generated.."

  enabled_count="$(printf "%s\n" "$enabled_list" | sed '/^[[:space:]]*$/d' | wc -l | tr -d ' ')"
  disabled_count="$(printf "%s\n" "$disabled_list" | sed '/^[[:space:]]*$/d' | wc -l | tr -d ' ')"

  # Build HTML
  cat >"$OUT_FILE" <<EOF
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DebianDC - Detailed User List</title>
$(light_css)
</head>
<body>
<div class="container">

  <div class="topbar">
    <div class="brand">
      <span class="logo"></span>
      <div>
        <h1>DebianDC — Detailed Domain Users Report</h1>
        <div class="meta">Generated: $(printf "%s" "$date_now" | h)</div>
      </div>
    </div>
    <div class="meta">
      <span class="pill">Users: $(printf "%s" "$total" | h)</span>
      <span class="pill badge-ok">Enabled: $(printf "%s" "$enabled_count" | h)</span>
      <span class="pill badge-bad">Disabled: $(printf "%s" "$disabled_count" | h)</span>
      <span class="pill">Host: $(printf "%s" "$hostname_fqdn" | h)</span>
    </div>
  </div>

  <div class="card">
    <div class="section-title">System Context</div>
    <table>
      <tr><th>Key</th><th>Value</th></tr>
      <tr><td><b>OS</b></td><td>$(printf "%s" "$os_pretty" | h)</td></tr>
      <tr><td><b>Samba Version</b></td><td>$(printf "%s" "$samba_ver" | h)</td></tr>
    </table>
  </div>

  <div class="card">
    <div class="section-title">Users Summary</div>
    <div class="meta" style="margin-bottom:8px;">
      Columns: Username · Enabled (userAccountControl bit2) · uidNumber · mail · lastLogonTimestamp · description
    </div>
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Status</th>
          <th>uidNumber</th>
          <th>mail</th>
          <th>lastLogonTimestamp</th>
          <th>description</th>
        </tr>
      </thead>
      <tbody>
$(cat "$summary_rows")
      </tbody>
    </table>
  </div>

  <div class="card">
    <div class="section-title">Enabled Users — Details</div>
    <div class="meta">Each section is: <b>samba-tool user show &lt;username&gt;</b></div>
EOF

  # Enabled details
  printf "%s\n" "$enabled_list" | sed '/^[[:space:]]*$/d' | while IFS= read -r u; do
    detail_file="${DETAIL_DIR}/${u}.txt"
    [ -f "$detail_file" ] || continue
    cat >>"$OUT_FILE" <<EOF
    <hr class="hr">
    <div class="user-title">User: $(printf "%s" "$u" | h)</div>
    <div class="code"><pre>$(cat "$detail_file" | h)</pre></div>
EOF
  done

  cat >>"$OUT_FILE" <<EOF
  </div>

  <div class="card">
    <div class="section-title">Disabled Users — Details</div>
    <div class="meta">Disabled detection: <b>userAccountControl &amp; 2 != 0</b></div>
EOF

  # Disabled details
  printf "%s\n" "$disabled_list" | sed '/^[[:space:]]*$/d' | while IFS= read -r u; do
    detail_file="${DETAIL_DIR}/${u}.txt"
    [ -f "$detail_file" ] || continue
    cat >>"$OUT_FILE" <<EOF
    <hr class="hr">
    <div class="user-title">User: $(printf "%s" "$u" | h)</div>
    <div class="code"><pre>$(cat "$detail_file" | h)</pre></div>
EOF
  done

  cat >>"$OUT_FILE" <<'EOF'
  </div>

  <div class="footer">Generated by <b>DebianDC Manager</b></div>
</div>
</body>
</html>
EOF

  rm -f "$summary_rows" 2>/dev/null || true

  echo "100"
  echo "# Report prepared. Report Opened.."
}

open_report() {
  if have netsurf-gtk; then
    netsurf-gtk "$OUT_FILE" >/dev/null 2>&1 || true
  else
    if have zenity; then
      zenity --info --title="DebianDC Reports" --width=520 \
        --text="Report Generated:\n\n$OUT_FILE\n\nReport Viewer Not Found!"
    else
      echo "Report generated: $OUT_FILE"
      echo "Report Viewer Not Found!"
    fi
  fi
}

main() {
  mkdir -p "$REPORT_DIR" "$DETAIL_DIR" 2>/dev/null

  if have zenity; then
    ( generate_report ) | zenity --progress \
        --title="DebianDC Reports" \
        --text="Detailed Domain Users Report" \
        --percentage=0 \
        --auto-close \
        --no-cancel \
        --width=560
  else
    # for no zenity
    generate_report >/dev/null 2>&1 || true
  fi

  open_report
}

main "$@"

